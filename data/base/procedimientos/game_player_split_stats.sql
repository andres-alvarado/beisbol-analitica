USE baseball;

DROP PROCEDURE game_player_split_stats;

DELIMITER //

CREATE PROCEDURE game_player_split_stats()
BEGIN

INSERT INTO game_player_split_stats(
    gamePk,
    atBatIndex,
    battingTeamId,
    batterId,
    batSide,
    pitchingTeamId,
    pitcherId,
    pitchHand,
    menOnBase,
    balks,
    batterInterferences,
    bunts,
    catcherInterferences,
    doubles,
    fanInterferences,
    fieldErrors,
    fieldersChoice,
    flyouts,
    forceOuts,
    groundedIntoDoublePlays,
    groundOuts,
    hitByPitch,
    homeRuns,
    intentionalWalks,
    lineOuts,
    passedBalls,
    popOuts,
    runsBattedIn,
    sacBunts,
    sacFlies,
    singles,
    strikeOuts,
    triples,
    triplePlays,
    walks,
    wildPitches,
    -- Coming from the pitches tables
    balls,
    ballsPitchOut,
    ballsInDirt,
    intentBalls,
    fouls,
    foulBunts,
    foulTips,
    foulPitchOuts,
    hitIntoPlay,
    pitches,
    pitchOuts,
    strikes,
    strikesCalled,
    strikesPitchOuts,
    missedBunts,
    swingAndMissStrikes,
    swingsPitchOuts,
    swings,
    swingsZeroAndZero,
    swingsZeroAndOne,
    swingsZeroAndTwo,
    swingsOneAndZero,
    swingsOneAndOne,
    swingsOneAndTwo,
    swingsTwoAndZero,
    swingsTwoAndOne,
    swingsTwoAndTwo,
    swingsThreeAndZero,
    swingsThreeAndOne,
    swingsThreeAndTwo,
    flyBalls,
    groundBalls,
    lineDrives,
    popUps,
    groundBunts,
    popupBunts,
    lineDriveBunts
  )
SELECT
  gamePk,
  atBatIndex,
  battingTeamId,
  batterId,
  batSide,
  pitchingTeamId,
  pitcherId,
  pitchHand,
  menOnBase,
  IF(event = 'Balk', 1, 0) AS balks,
  IF(event = 'Batter Interference', 1, 0) AS batterInterferences,
  IF(event IN ('Bunt Groundout', 'Bunt Lineout', 'Bunt Pop Out'), 1, 0) AS bunts,
  IF(event = 'Catcher Interference', 1, 0) AS catcherInterferences,
  IF(event = 'Double', 1, 0) AS doubles,
  IF(event = 'Fan Interference', 1, 0) AS fanInterferences,
  IF(event = 'Field Error', 1, 0) fieldErrors,
  IF(event IN ('Fielders Choice', 'Fielders Choice Out'), 1, 0) AS fieldersChoice,
  IF(event = 'Flyout', 1, 0) AS flyouts,
  IF(event = 'Forceout', 1, 0) AS forceOuts,
  IF(event IN ('Double Play', 'Grounded Into DP'), 1, 0) AS groundedIntoDoublePlays,
  IF(event = 'Groundout', 1, 0) AS groundOuts,
  IF(event = 'Hit By Pitch', 1, 0) AS hitByPitch,
  IF(event = 'Home Run', 1, 0) AS homeRuns,
  IF(event = 'Intent Walk', 1, 0) AS intentionalWalks,
  IF(event = 'Lineout', 1, 0) AS lineOuts,
  IF(event = 'Passed Ball', 1, 0) AS passedBalls,
  IF(event = 'Pop Out', 1, 0) AS popOuts,
  rbi AS runsBattedIn,
  IF(event IN ('Sac Bunt', 'Sac Bunt Double Play'), 1, 0) AS sacBunts,
  IF(event IN ('Sac Fly', 'Sac Fly Double Play'), 1, 0) AS sacFlies,
  IF(event = 'Single', 1, 0) AS singles,
  IF(event IN ('Strikeout', 'Strikeout Double Play', 'Strikeout Triple Play'), 1, 0)
    AS strikeOuts,
  IF(event = 'Triple', 1, 0) AS triples,
  IF(event = 'Triple Play', 1, 0) AS triplePlays,
  IF(event = 'Walk', 1, 0) AS walks,
  IF(event = 'Wild Pitch', 1, 0) AS wildPitches,
  -- These metrics come from the pitches table
  SUM(balls) AS balls,
  SUM(ballsPitchOut) AS ballsPitchOut,
  SUM(ballsInDirt) AS ballsInDirt,
  SUM(intentBalls) AS intentBalls,
  SUM(fouls) AS fouls,
  SUM(foulBunts) AS foulBunts,
  SUM(foulTips) AS foulTips,
  SUM(foulPitchOuts) AS foulPitchOuts,
  SUM(hitIntoPlay) AS hitIntoPlay,
  SUM(pitches) AS pitches,
  SUM(pitchOuts) AS pitchOuts,
  SUM(strikes) AS strikes,
  SUM(strikesCalled) AS strikesCalled,
  SUM(strikesPitchOuts) AS strikesPitchOuts,
  SUM(missedBunts) AS missedBunts,
  SUM(swingAndMissStrikes) AS swingAndMissStrikes,
  SUM(swingsPitchOuts) AS swingsPitchOuts,
  SUM(swings) AS swings,
  -- Swings Per Ball and Strikes
  -- 0 Ball(s)
  SUM(swingsZeroAndZero) AS swingsZeroAndZero,
  SUM(swingsZeroAndOne) AS swingsZeroAndOne,
  SUM(swingsZeroAndTwo) AS swingsZeroAndTwo,
  -- 1 Ball(s)
  SUM(swingsOneAndZero) AS swingsOneAndZero,
  SUM(swingsOneAndOne) AS swingsOneAndOne,
  SUM(swingsOneAndTwo) AS swingsOneAndTwo,
  -- 2 Ball(s)
  SUM(swingsTwoAndZero) AS swingsTwoAndZero,
  SUM(swingsTwoAndOne) AS swingsTwoAndOne,
  SUM(swingsTwoAndTwo) AS swingsTwoAndTwo,
  -- 3 Ball(s)
  SUM(swingsThreeAndZero) AS swingsThreeAndZero,
  SUM(swingsThreeAndOne) AS swingsThreeAndOne,
  SUM(swingsThreeAndTwo) AS swingsThreeAndTwo,
  -- Trajectories
  SUM(flyBalls) AS flyBalls,
  SUM(groundBalls) AS groundBalls,
  SUM(lineDrives) AS lineDrives,
  SUM(popUps) AS popUps,
  SUM(groundBunts) AS groundBunts,
  SUM(popupBunts) AS popupBunts,
  SUM(lineDriveBunts) AS lineDriveBunts
FROM atbats
GROUP BY 1, 2, 3, 4, 5, 6, 7, 8, 9;

COMMIT;

END //

DELIMITER ;
